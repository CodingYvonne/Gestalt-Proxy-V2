<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œå½¢ç”Ÿæ´»ææ¡ˆ - Gestalt Life Proposal</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®šå­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Serif+TC:wght@200..900&display=swap');
        body {
            font-family: 'Noto Serif TC', 'Inter', serif; 
            background-color: #A47963;
            background-image: url('https://images.unsplash.com/photo-1549495034-728b7e283287?q=80&w=1974&auto=format&fit=crop'); 
            background-size: cover;
            background-attachment: fixed;
            background-position: center center;
        }
        .bg-primary-dark { background-color: #A47963; } 
        .hover\:bg-primary-dark-hover:hover { background-color: #926A57; }
        .bg-accent-medium { background-color: #A47963; } 
        .hover\:bg-accent-medium-hover:hover { background-color: #926A57; }
        .bg-ground-soft { background-color: #93B48B; }
        .hover\:bg-ground-soft-hover:hover { background-color: #7a9973; }
        .text-primary-dark { color: #A47963; } 
        .bg-end-conversation { background-color: #5A352A; }
        .view { display: none; }
        .view.active { display: block; }
        .emoji-button { transition: transform 0.1s ease-in-out; }
        .emoji-button:hover { transform: scale(1.2); }
        .emoji-button.selected { background-color: #A47963; color: white !important; transform: scale(1.15); }
        #chat-history-container { max-height: 400px; overflow-y: auto; }
        .task-type-badge { font-size: 0.75rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-lg bg-white rounded-3xl shadow-xl overflow-hidden transform transition-all duration-300">
        <header class="bg-primary-dark p-6">
            <h1 class="text-3xl font-extrabold text-white text-center">å®Œå½¢ç”Ÿæ´»ææ¡ˆ</h1>
            <p class="text-sm text-gray-200 text-center mt-1">Gestalt Life Proposal</p>
        </header>

        <main class="p-6 md:p-8">
            <div id="views-container" class="space-y-6">
                <!-- 1. Home View -->
                <div id="view-home" class="view active">
                    <div class="min-h-[150px] flex flex-col justify-center items-center text-center p-6 rounded-xl">
                        <p class="text-xl text-gray-700 font-semibold mb-6">æ­¡è¿ä¾†åˆ°å®Œå½¢è¦ºå¯Ÿçš„æ­¤åˆ»ã€‚</p>
                        <div class="space-y-4 w-full">
                            <button onclick="switchView('random-tools')" class="w-full px-4 py-3 bg-ground-soft text-white font-bold text-lg rounded-xl shadow-lg hover:bg-ground-soft-hover transition-all transform hover:scale-[1.02] active:scale-[0.98]">æˆ‘æƒ³éš¨æ©Ÿç²å¾—è¡Œå‹•æŒ‡ä»¤</button>
                            <button onclick="switchView('ai-interaction')" class="w-full px-4 py-3 bg-accent-medium text-white font-bold text-lg rounded-xl shadow-lg hover:bg-accent-medium-hover transition-all transform hover:scale-[1.02] active:scale-[0.98]">æˆ‘æƒ³è·Ÿå®Œå½¢è¡Œè€…å°è©±</button>
                        </div>
                        <p class="text-sm text-gray-500 mt-6">è«‹é¸æ“‡ä½ ç•¶ä¸‹æƒ³åšçš„è¦ºå¯Ÿç·´ç¿’ã€‚</p>
                    </div>
                </div>

                <!-- 2. Random View -->
                <div id="view-random-tools" class="view">
                    <div id="display-card-random" class="min-h-[150px] flex flex-col justify-center items-center text-center bg-gray-50 border border-[#93B48B] p-6 rounded-xl">
                        <div id="message-content-random">
                            <p class="text-lg text-gray-500">è«‹é¸æ“‡ä¸‹æ–¹æŒ‡ä»¤ï¼Œé–‹å§‹è¦ºå¯Ÿã€‚</p>
                        </div>
                    </div>
                    <div id="task-interaction-area" class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden"></div>
                    <div id="image-result-area" class="mt-6"></div>
                    <div class="mt-6 space-y-4">
                        <button id="quote-button" class="w-full py-3 bg-primary-dark text-white font-bold rounded-xl shadow-lg hover:bg-primary-dark-hover transition-all">âœ¨ å®Œå½¢å¤§å¸«çš„ç¶“å…¸èªéŒ„</button>
                        <button id="task-button" class="w-full py-3 bg-ground-soft text-white font-bold rounded-xl shadow-lg hover:bg-ground-soft-hover transition-all">ğŸŒªï¸ å®Œå½¢çš„è¦ºå¯Ÿè¡Œå‹•</button>
                    </div>
                    <button onclick="switchView('home', 'random')" class="mt-6 w-full text-sm text-gray-500 py-2 border border-gray-300 rounded-lg hover:text-primary-dark hover:border-primary-dark transition">â† è¿”å›èµ·å§‹é </button>
                </div>

                <!-- 3. AI View -->
                <div id="view-ai-interaction" class="view">
                    <div id="chat-history-container" class="min-h-[150px] space-y-4 p-4 bg-gray-50 border border-[#93B48B] rounded-xl transition-all">
                        <p class="text-lg text-gray-500 text-center">å®Œå½¢è¡Œè€…æ­£åœ¨ç­‰å€™æ‚¨çš„é‚€è«‹ã€‚</p>
                    </div>
                    <div id="palette-result-area" class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden"></div>
                    <div id="chat-input-area" class="mt-6 space-y-3 p-4 bg-gray-50 rounded-xl border">
                        <label class="block text-sm font-bold text-gray-700">ğŸ’¬ å¯«ä¸‹ä½ ç¾åœ¨çš„ç…©æƒ±æˆ–æ„Ÿå—ï¼š</label>
                        <textarea id="user-concern" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#A47963] focus:border-[#A47963] transition text-gray-800" placeholder="ä¾‹å¦‚ï¼šæˆ‘å°æœŸæœ«å ±å‘Šæ„Ÿåˆ°ç„¦æ…®..."></textarea>
                        <button id="submit-concern-button" class="w-full py-3 bg-accent-medium text-white font-bold rounded-xl shadow-lg hover:bg-accent-medium-hover transition-all disabled:opacity-50" disabled>
                            <span id="concern-button-text">æ¥æ”¶å®Œå½¢å›æ‡‰</span>
                        </button>
                    </div>
                    <button id="end-conversation-button" class="mt-6 w-full py-3 bg-end-conversation text-white font-bold rounded-xl hidden" onclick="handleEndConversation()">çµæŸæœ¬æ¬¡å°è©±</button>
                    <div id="status-message" class="mt-4 text-center text-red-500 hidden"></div>
                    <button onclick="switchView('home', 'ai')" class="mt-4 w-full text-sm text-gray-500 py-2 border border-gray-300 rounded-lg hover:text-primary-dark transition">â† è¿”å›èµ·å§‹é </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // === æ ¸å¿ƒè¨­å®šï¼šæŒ‡å‘ Vercel Proxy ç¨ç«‹ç«¯é» ===
        const CHAT_PROXY_URL = "/api/chat-proxy";
        const IMAGE_PROXY_URL = "/api/image-proxy";
        const SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä½å®Œå½¢æ²»ç™‚å¼•å°è€…ï¼ˆGestalt Facilitatorï¼‰ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½¿ç”¨è€…æè¿°çš„ç…©æƒ±æˆ–ç•¶ä¸‹æ„Ÿå—ï¼Œçµ¦å‡ºä¸€å€‹ç°¡çŸ­ã€å°ˆæ³¨æ–¼æ­¤åˆ»è¦ºå¯Ÿçš„å›æ‡‰ã€‚ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œä¸çµ¦å»ºè­°ï¼Œå¼•å°ä½¿ç”¨è€…å°‡æ³¨æ„åŠ›å¸¶å›ç•¶ä¸‹çš„æ„Ÿå®˜ã€æƒ…ç·’æˆ–èº«é«”æ„Ÿå—ï¼Œä¸¦ä½¿ç”¨ã€æˆ‘ã€èªè¨€å›æ‡‰ã€‚";

        let chatHistory = [];
        let currentSelectedEmoji = null;
        let chatRound = 0;

        const gestaltQuotes = [
            { quote: "ç„¦æ…®æ˜¯å¾ã€ç¾åœ¨ã€åˆ°ã€æœªä¾†ã€ä¹‹é–“çš„ç¸«éš™ã€‚", author: "Fritz Perls" },
            { quote: "å¤±å»ç†æ™ºï¼Œæ‰¾å›æ„Ÿå®˜ã€‚", author: "Fritz Perls" },
            { quote: "è¦ºå¯Ÿå³ç™‚ç™’ã€‚", author: "Fritz Perls" },
            { quote: "å¾ˆå¥½å–”ï¼", author: "è¬æ›œä»»" },
            { quote: "æ˜¯ä»€éº¼é˜»æ“‹äº†ä½ ï¼Ÿ", author: "è¬æ›œä»»" },
            { quote: "æ´»åœ¨ç•¶ä¸‹ã€‚", author: "Fritz Perls" }
        ];

        const awarenessTasks = [
            { type: 'æ„Ÿå®˜è¦ºå¯Ÿ', color: 'bg-[#f0f5ee] text-[#A47963]', tasks: ["é–‰ä¸Šçœ¼ï¼Œæ‰¾å‡ºç©ºæ°£ä¸­ä¸‰ç¨®ä¸åŒçš„å‘³é“ã€‚", "å°ˆæ³¨è†è½å‘¨é­æœ€å¾®å¼±çš„è²éŸ³ï¼ŒæŒçºŒ 30 ç§’ã€‚", "è§¸æ‘¸ä½ çš„æŒ‡å°–ï¼Œæ„Ÿå—æº«åº¦èˆ‡ç´‹ç†ã€‚"] },
            { type: 'èº«é«”è¦ºå¯Ÿ', color: 'bg-[#d0e6ec] text-[#A47963]', tasks: ["æ·±å¸ä¸€å£æ°£ï¼Œæ„Ÿå—æ°£é«”æ˜¯åœåœ¨èƒ¸å£é‚„æ˜¯é€²åˆ°è‚šå­ï¼Ÿ", "ç·©æ…¢è³èµ·è‚©è†€ï¼Œç„¶å¾Œè®“å®ƒå€‘å®Œå…¨æ”¾é¬†ï¼Œé‡è¤‡ä¸‰æ¬¡ã€‚"] },
            { type: 'èªæ„è½‰åŒ–', color: 'bg-[#e6e0f3] text-[#A47963]', tasks: ["æŠŠã€æˆ‘ä¸èƒ½...ã€æ”¹æˆã€æˆ‘ä¸é¡˜æ„...ã€ï¼Œå†èªªä¸€æ¬¡æ„Ÿå—çœ‹çœ‹ã€‚", "èªªå‡ºã€æˆ‘é¸æ“‡...ã€ä¾†æè¿°ä½ ä»Šå¤©çš„æŸå€‹è¡Œå‹•ã€‚"] }
        ];

        const EMOJIS = [
            { icon: 'ğŸ˜Œ', label: 'æ”¾é¬†' }, { icon: 'ğŸ¤”', label: 'å¥½å¥‡' }, { icon: 'ğŸ˜«', label: 'å£“åŠ›' }, 
            { icon: 'ğŸ˜„', label: 'å–œæ‚…' }, { icon: 'ğŸ˜ ', label: 'æ†¤æ€’' }, { icon: 'ğŸ˜®', label: 'é©šè¨' }, { icon: 'ğŸ˜”', label: 'é›£é' }
        ];

        // === ä¿®æ­£å¾Œçš„çµ±ä¸€è«‹æ±‚å‡½å¼ (æ ¹æ“š type é¸å–æ­£ç¢ºç«¯é») ===
        async function callProxyAPI(type, payload) {
            const url = (type === 'text') ? CHAT_PROXY_URL : IMAGE_PROXY_URL;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload) // é€™è£¡ç›´æ¥å‚³é€åŸæœ¬ Google API æ ¼å¼çš„ payload
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'API è«‹æ±‚å¤±æ•—');
            }
            return await response.json();
        }

        // === è¦–åœ–åˆ‡æ›é‚è¼¯ ===
        function switchView(target, source = null) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${target}`).classList.add('active');
            
            if (target === 'home') {
                chatHistory = [];
                chatRound = 0;
                document.getElementById('palette-result-area').classList.add('hidden');
                document.getElementById('chat-input-area').classList.remove('hidden');
                document.getElementById('chat-history-container').innerHTML = '<p class="text-lg text-gray-500 text-center">å®Œå½¢è¡Œè€…æ­£åœ¨ç­‰å€™æ‚¨çš„é‚€è«‹ã€‚</p>';
                document.getElementById('chat-history-container').style.opacity = '1';
                document.getElementById('end-conversation-button').classList.add('hidden');
                if (source === 'random') {
                    document.getElementById('task-interaction-area').classList.add('hidden');
                    document.getElementById('image-result-area').innerHTML = '';
                }
            }
        }

        // === AI å°è©±è™•ç† ===
        async function handleConcernSubmission() {
            const input = document.getElementById('user-concern');
            const btn = document.getElementById('submit-concern-button');
            const status = document.getElementById('status-message');
            const text = input.value.trim();
            if (!text) return;

            btn.disabled = true;
            status.classList.add('hidden');
            chatHistory.push({ role: 'user', parts: [{ text }] });
            renderChat();
            input.value = '';

            try {
                const result = await callProxyAPI('text', {
                    contents: chatHistory,
                    systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
                });
                const response = result.candidates[0].content.parts[0].text;
                chatHistory.push({ role: 'model', parts: [{ text: response }] });
                renderChat();
                document.getElementById('end-conversation-button').classList.remove('hidden');
                chatRound++;
            } catch (e) {
                status.textContent = "å®Œå½¢å›æ‡‰å¤±æ•—: " + e.message;
                status.classList.remove('hidden');
                chatHistory.pop(); // å¤±æ•—å‰‡ç§»é™¤æœ€å¾Œä¸€æ¢è¨Šæ¯
                renderChat();
            } finally {
                btn.disabled = false;
            }
        }

        // === åœ–ç‰‡ç”Ÿæˆè™•ç† ===
        async function handleTaskSubmission() {
            const obs = document.getElementById('task-observation').value.trim();
            const resArea = document.getElementById('image-result-area');
            const btn = document.getElementById('generate-image-button');
            if (obs.length < 5) return alert("è«‹è‡³å°‘è¼¸å…¥ 5 å€‹å­—ä¾†æè¿°ä½ çš„è¦ºå¯Ÿï¼");

            btn.disabled = true;
            resArea.innerHTML = `<div class="text-center text-gray-500 py-4 animate-pulse">æ­£åœ¨æ•æ‰å…§åœ¨é¢¨æ™¯...</div>`;
            
            try {
                const emotion = EMOJIS.find(e => e.icon === currentSelectedEmoji)?.label || "å¹³éœ";
                const prompt = `Photorealistic nature photography, inner state of "${emotion}", based on: "${obs}". Cinematic, high detail, artistic.`;
                const result = await callProxyAPI('image', {
                    instances: { prompt },
                    parameters: { sampleCount: 1 }
                });
                const b64 = result.predictions[0].bytesBase64Encoded;
                resArea.innerHTML = `
                    <div class="mt-4 p-4 bg-white rounded-xl shadow-lg border border-gray-200">
                        <h4 class="text-lg font-bold text-[#A47963] mb-2 text-center">ğŸ–¼ï¸ ä½ çš„å°ˆå±¬è¦ºå¯Ÿé¢¨æ™¯</h4>
                        <img src="data:image/png;base64,${b64}" class="w-full h-auto rounded-lg shadow-md">
                        <p class="text-xs text-gray-400 mt-2 text-center">é€™æ˜¯æ ¹æ“šä½ çš„è¦ºå¯Ÿï¼Œç‚ºä½ ç”Ÿæˆçš„æ­¤åˆ»é¢¨æ™¯ã€‚</p>
                    </div>`;
            } catch (e) {
                resArea.innerHTML = `<p class="text-red-500 text-center">åœ–ç‰‡ç”Ÿæˆå¤±æ•—: ${e.message}</p>`;
            } finally {
                btn.disabled = false;
            }
        }

        // === çµæŸå°è©±ç”Ÿæˆè‰²ç¥¨ ===
        async function handleEndConversation() {
            const area = document.getElementById('palette-result-area');
            const inputArea = document.getElementById('chat-input-area');
            const btn = document.getElementById('end-conversation-button');

            inputArea.classList.add('hidden');
            btn.classList.add('hidden');
            area.classList.remove('hidden');
            area.innerHTML = `<div class="text-center py-4">å®Œå½¢è¡Œè€…æ­£åœ¨æº–å‚™ä½ çš„é¡è‰²ç¦®ç‰©...</div>`;

            try {
                const summary = chatHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n');
                const prompt = `Analyze this Gestalt dialogue and return exactly 3 representative HEX colors in JSON. Dialogue: ${summary}`;
                
                const result = await callProxyAPI('text', {
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                summaryEmotion: { type: "STRING" },
                                palette: { type: "ARRAY", items: { type: "STRING" } }
                            }
                        }
                    }
                });

                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                const colorBlocks = data.palette.map(c => `
                    <div style="background-color: ${c}; height: 80px;" class="w-full rounded-lg shadow flex items-end justify-center p-1 text-[10px] text-white">
                        <span class="bg-black/40 px-1 rounded">${c}</span>
                    </div>`).join('');

                area.innerHTML = `
                    <h3 class="text-xl font-bold text-center mb-3">ğŸ å®Œå½¢è¡Œè€…çš„å°ˆå±¬ç¦®ç‰©</h3>
                    <p class="text-center text-sm mb-4">æ„Ÿè¦ºåˆ°äº†é€™æ®µå°è©±ä¸­çš„<span class="font-bold">ã€${data.summaryEmotion}ã€</span></p>
                    <div class="grid grid-cols-3 gap-2">${colorBlocks}</div>
                    <p class="text-xs text-gray-400 mt-4 text-center">å¸¶è‘—é€™ä»½è¦ºå¯Ÿçš„é¡è‰²ç¹¼çºŒç”Ÿæ´»å§ã€‚</p>`;
                document.getElementById('chat-history-container').style.opacity = '0.4';
            } catch (e) {
                area.innerHTML = `<p class="text-center text-gray-500">ç¦®ç‰©ç”Ÿæˆæ™‚å‡ºäº†é»å°æ’æ›²ï¼Œä½†è¦ºå¯Ÿå·²åœ¨å¿ƒä¸­ã€‚</p>`;
            }
        }

        // === æ¸²æŸ“èŠå¤©æ­·å² ===
        function renderChat() {
            const container = document.getElementById('chat-history-container');
            container.innerHTML = chatHistory.map(m => `
                <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[85%] p-3 rounded-xl shadow-sm ${m.role === 'user' ? 'bg-[#93B48B] text-white' : 'bg-white border'}">
                        <p class="text-[10px] font-bold mb-1 opacity-70">${m.role === 'user' ? 'YOU' : 'GESTALT WALKER'}</p>
                        <p class="text-sm">${m.parts[0].text.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>`).join('');
            container.scrollTop = container.scrollHeight;
        }

        // === é»é¸è¡¨æƒ… ===
        window.selectEmoji = function(el) {
            document.querySelectorAll('.emoji-button').forEach(b => b.classList.remove('selected', 'bg-[#A47963]', 'text-white'));
            el.classList.add('selected', 'bg-[#A47963]', 'text-white');
            currentSelectedEmoji = el.dataset.emoji;
        }

        // === åˆå§‹åŒ–äº‹ä»¶ ===
        window.onload = () => {
            // åè¨€æŒ‰éˆ•
            document.getElementById('quote-button').onclick = () => {
                const q = gestaltQuotes[Math.floor(Math.random() * gestaltQuotes.length)];
                document.getElementById('message-content-random').innerHTML = `
                    <p class="task-type-badge bg-[#d0e6ec] text-[#A47963] mb-4 inline-block">å¤§å¸«èªéŒ„</p>
                    <p class="text-xl font-semibold text-gray-800 leading-relaxed">${q.quote}</p>
                    <p class="text-sm text-gray-500 mt-2">-- ${q.author}</p>`;
                document.getElementById('task-interaction-area').classList.add('hidden');
                document.getElementById('image-result-area').innerHTML = '';
            };

            // ä»»å‹™æŒ‰éˆ•
            document.getElementById('task-button').onclick = () => {
                const group = awarenessTasks[Math.floor(Math.random() * awarenessTasks.length)];
                const task = group.tasks[Math.floor(Math.random() * group.tasks.length)];
                document.getElementById('message-content-random').innerHTML = `
                    <p class="task-type-badge ${group.color} mb-4 inline-block">${group.type}</p>
                    <p class="text-xl font-bold text-gray-800 leading-relaxed">${task}</p>`;
                
                const interaction = document.getElementById('task-interaction-area');
                interaction.classList.remove('hidden');
                interaction.innerHTML = `
                    <div class="space-y-4">
                        <label class="block text-sm font-bold text-gray-700">ğŸ’¡ ä½ çš„æ­¤åˆ»è¦ºå¯Ÿï¼š</label>
                        <textarea id="task-observation" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-[#A47963]" placeholder="åœ¨æ­¤å¯«ä¸‹ä½ çš„é«”æœƒ..."></textarea>
                        <div class="flex flex-wrap gap-2 justify-center">
                            ${EMOJIS.map(e => `<button onclick="selectEmoji(this)" data-emoji="${e.icon}" class="emoji-button text-2xl p-2 rounded-full border border-gray-100 bg-white hover:bg-gray-50">${e.icon}</button>`).join('')}
                        </div>
                        <button id="generate-image-button" onclick="handleTaskSubmission()" class="w-full py-3 bg-accent-medium text-white font-bold rounded-xl shadow-md hover:bg-accent-medium-hover transition-all">ç²å¾—å°ˆå±¬ç…§ç‰‡</button>
                    </div>`;
                document.getElementById('image-result-area').innerHTML = '';
            };

            // AI å°è©±è¼¸å…¥ç›£è½
            document.getElementById('user-concern').oninput = (e) => {
                document.getElementById('submit-concern-button').disabled = !e.target.value.trim();
            };
            document.getElementById('submit-concern-button').onclick = handleConcernSubmission;
        };
    </script>
</body>
</html>
